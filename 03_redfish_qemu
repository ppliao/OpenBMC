# OpenBMC Redfish on QEMU å¯¦é©—ç´€éŒ„

## ğŸ¯ ç›®æ¨™
åœ¨ QEMU ä¸Šå•Ÿå‹• OpenBMCï¼Œä¸¦é€é Redfish API è®€å–ç³»çµ±ç‹€æ…‹ã€‚

## âš™ï¸ ç’°å¢ƒ
- Host: Ubuntu 20.04 / WSL2
- QEMU target: `qemuarm`
- Image: `obmc-phosphor-image`
- Networking: slirp (host port forwarding)
- Tools: `curl`, `ssh`

## ğŸ”‘ æ­¥é©Ÿ
1. å•Ÿå‹•QEMU
   $ . setup qemuarm
   $ runqemu qemuarm obmc-phosphor-image slirp hostfwd=tcp:127.0.0.1:2222-:22
2. setup port   
   $ ssh -N -p 2222 -L 8443:127.0.0.1:443 root@127.0.0.1          //å»ºç«‹ VM port fowarding
   $ curl -k https://127.0.0.1:8443/redfish/v1                     //test host redfish entrace
   $ curl -k -u root:0penBmc https://127.0.0.1:8443/redfish/v1/Systems

##âœ…Result
{
  "@odata.id": "/redfish/v1/Systems",      // ä»£è¡¨é€™å€‹ JSON çš„ API endpoint è·¯å¾‘ã€‚
  "@odata.type": "#ComputerSystemCollection.ComputerSystemCollection",
  "Members": [
    {
      "@odata.id": "/redfish/v1/Systems/system"  // è¡¨ç¤ºé€™å€‹ BMC åªç®¡ç†ä¸€å°ç³»çµ±
  ],
  "Members@odata.count": 1,
  "Name": "Computer System Collection"
}

-------------------------------------------------------------------------------------

## ğŸ¯ ç›®æ¨™
åœ¨ QEMU ä¸Šå•Ÿå‹• OpenBMCï¼Œä¸¦é€é Redfish API è®€å– å–®ä¸€ ç³»çµ±ç‹€æ…‹ã€‚

## ğŸ”‘ æ­¥é©Ÿ
1.
   $ curl -k -u root:0penBmc https://127.0.0.1:8443/redfish/v1/Systems/system

##âœ…Result
{
  "@odata.id": "/redfish/v1/Systems/system",
  "@odata.type": "#ComputerSystem.v1_22_0.ComputerSystem",
  "Actions": {                                        // YOU can use this api make some action 
    "#ComputerSystem.Reset": {
      "@Redfish.ActionInfo": "/redfish/v1/Systems/system/ResetActionInfo",
      "target": "/redfish/v1/Systems/system/Actions/ComputerSystem.Reset"
    }
  },
  "Bios": { 
    "@odata.id": "/redfish/v1/Systems/system/Bios"
  },
  "Boot": {                                            // The next startup behavior
    "AutomaticRetryAttempts": 3,
    "AutomaticRetryConfig": "RetryAttempts",
    "AutomaticRetryConfig@Redfish.AllowableValues": [
      "Disabled",
      "RetryAttempts"
    ],
    "BootSourceOverrideEnabled": "Disabled",
    "BootSourceOverrideMode": "UEFI",
    "BootSourceOverrideMode@Redfish.AllowableValues": [
      "Legacy",
      "UEFI"
    ],
    "BootSourceOverrideTarget": "None",
    "BootSourceOverrideTarget@Redfish.AllowableValues": [
      "None",
      "Pxe",
      "Hdd",
      "Cd",
      "Diags",
      "BiosSetup",
      "Usb"
    ],
    "RemainingAutomaticRetryAttempts": 3,
    "StopBootOnFault": "Never",
    "TrustedModuleRequiredToBoot": "Disabled"
  },
  "BootProgress": {
    "LastState": "None",
    "LastStateTime": "1970-01-01T00:00:00.000000+00:00"
  },
  "Description": "Computer System",
  "FabricAdapters": {
    "@odata.id": "/redfish/v1/Systems/system/FabricAdapters"
  },
  "GraphicalConsole": {
    "ConnectTypesSupported": [
      "KVMIP"
    ],
    "MaxConcurrentSessions": 4,
    "ServiceEnabled": true
  },
  "Id": "system",
  "LastResetTime": "1970-01-01T00:00:00+00:00",
  "Links": {
    "ManagedBy": [
      {
        "@odata.id": "/redfish/v1/Managers/bmc"
      }
    ]
  },
  "LogServices": {
    "@odata.id": "/redfish/v1/Systems/system/LogServices"
  },
  "Memory": {
    "@odata.id": "/redfish/v1/Systems/system/Memory"
  },
  "MemorySummary": {
    "TotalSystemMemoryGiB": 0.0
  },
  "Name": "system",
  "PCIeDevices": [],
  "PCIeDevices@odata.count": 0,
  "PowerRestorePolicy": "AlwaysOff",
  "PowerState": "Off",
  "ProcessorSummary": {
    "Count": 0
  },
  "Processors": {
    "@odata.id": "/redfish/v1/Systems/system/Processors"
  },
  "SerialConsole": {
    "IPMI": {
      "ServiceEnabled": true
    },
    "MaxConcurrentSessions": 15,
    "SSH": {
      "HotKeySequenceDisplay": "Press ~. to exit console",
      "Port": 2200,
      "ServiceEnabled": true
    }
  },
  "Status": {
    "Health": "OK",
    "State": "Disabled"
  },
  "Storage": {
    "@odata.id": "/redfish/v1/Systems/system/Storage"
  },
  "SystemType": "Physical"

  ---------------------------------------------------------------------------

  ## ğŸ¯ ç›®æ¨™
  åœ¨ QEMU ä¸Šå•Ÿå‹• OpenBMCï¼Œä¸¦é€é Redfish API å˜—è©¦åŸ·è¡Œä¸»æ©Ÿé–‹é—œæ©Ÿ (Reset)ï¼Œè§€å¯Ÿç³»çµ±ç‹€æ…‹è®ŠåŒ–ã€‚

  ##ğŸ”‘ æ­¥é©Ÿ
  1. æ¸¬è©¦ Redfish port 
     $ curl -k https://127.0.0.1:2443/redfish/v1
     $ curl -k -u root:0penBmc https://127.0.0.1:2443/redfish/v1/Systems
  2. é–‹æ©Ÿ (ResetType=On)
     $ curl -k -u root:0penBmc -H "Content-Type: application/json" \
     -d '{"ResetType":"On"}' \
     https://127.0.0.1:2443/redfish/v1/Systems/system/Actions/ComputerSystem.Reset

  3. é—œæ©Ÿ (ResetType=ForceOff)
     $ curl -k -u root:0penBmc -H "Content-Type: application/json" \
     -d '{"ResetType":"ForceOff"}' \
     https://127.0.0.1:2443/redfish/v1/Systems/system/Actions/ComputerSystem.Reset

   4.æŸ¥è©¢ç‹€æ…‹
     $ curl -k -u root:0penBmc https://127.0.0.1:2443/redfish/v1/Systems/system \
     | jq '.PowerState,.BootProgress'

   ##âœ…Result
     % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                    Dload  Upload   Total   Spent    Left  Speed
     100  2487  100  2487    0     0   5895      0 --:--:-- --:--:-- --:--:--  5907
     "Off"
     {
     "LastState": "None",
     "LastStateTime": "1970-01-01T00:00:00.000000+00:00"
     }

-----------------------------------------------------------------------------------------


     
